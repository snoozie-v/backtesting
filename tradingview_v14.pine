//@version=5
indicator("V14 - 4H EMA Trend with 15M Entries & Volume", overlay=true, max_lines_count=500, max_labels_count=500)

// --- Inputs ---
ema_fast_len = input.int(9, "EMA Fast Length")
ema_slow_len = input.int(25, "EMA Slow Length")
vol_sma_len = input.int(20, "Volume SMA Length")
atr_len = input.int(14, "ATR Length")
stop_mult = input.float(1.5, "Stop Loss Multiplier")
tp_mult = input.float(3.0, "Take Profit Multiplier")
use_volume = input.bool(true, "Require Volume Confirmation")
exit_on_reversal = input.bool(true, "Exit on Trend Reversal")
cooldown_bars = input.int(4, "Cooldown Bars")
show_tp_sl_lines = input.bool(true, "Show TP/SL Lines")
show_trade_labels = input.bool(true, "Show Trade Plan Labels")
show_historical = input.bool(true, "Show Historical Win/Loss")

// --- Higher Timeframe (4H) Trend ---
ema9_4h = request.security(syminfo.tickerid, "240", ta.ema(close, ema_fast_len))
ema25_4h = request.security(syminfo.tickerid, "240", ta.ema(close, ema_slow_len))
uptrend_4h = ema9_4h > ema25_4h
downtrend_4h = ema9_4h < ema25_4h

// Plot 4H EMAs
plot(ema9_4h, color=color.blue, title="4H EMA Fast", linewidth=2)
plot(ema25_4h, color=color.orange, title="4H EMA Slow", linewidth=2)

// --- Lower Timeframe (15M) Entry Signals ---
ema9_15m = ta.ema(close, ema_fast_len)
ema25_15m = ta.ema(close, ema_slow_len)
long_crossover = ta.crossover(ema9_15m, ema25_15m)
short_crossover = ta.crossunder(ema9_15m, ema25_15m)

// Plot 15M EMAs (lighter)
plot(ema9_15m, color=color.new(color.blue, 60), title="15M EMA Fast")
plot(ema25_15m, color=color.new(color.orange, 60), title="15M EMA Slow")

// --- Volume Confirmation ---
vol_sma = ta.sma(volume, vol_sma_len)
high_volume = volume > vol_sma
vol_ratio = vol_sma > 0 ? volume / vol_sma : 0

// --- ATR for Stops ---
atr = ta.atr(atr_len)

// --- Cooldown Tracking ---
var int bars_since_signal = 999
bars_since_signal := bars_since_signal + 1

// --- Entry Conditions (with cooldown) ---
long_condition = long_crossover and uptrend_4h and (not use_volume or high_volume)
short_condition = short_crossover and downtrend_4h and (not use_volume or high_volume)

long_signal = long_condition and bars_since_signal >= cooldown_bars
short_signal = short_condition and bars_since_signal >= cooldown_bars

if long_signal or short_signal
    bars_since_signal := 0

// --- Calculate TP/SL Levels ---
long_sl = close - (atr * stop_mult)
long_tp = close + (atr * tp_mult)
short_sl = close + (atr * stop_mult)
short_tp = close - (atr * tp_mult)

// --- Trade Tracking for Win/Loss ---
var float active_entry = na
var float active_tp = na
var float active_sl = na
var int active_direction = 0  // 1 = long, -1 = short, 0 = none
var int active_bar = na
var bool trend_was_valid = true

// Win/Loss counters
var int total_wins = 0
var int total_losses = 0

// Check for trend reversal exit
trend_reversal_exit_long = exit_on_reversal and active_direction == 1 and not uptrend_4h
trend_reversal_exit_short = exit_on_reversal and active_direction == -1 and not downtrend_4h

// Check if active trade hit TP, SL, or trend reversal
if active_direction == 1  // Long trade active
    if high >= active_tp
        // WIN - hit TP
        if show_historical
            label.new(bar_index, active_tp, "WIN\nTP Hit", color=color.green, textcolor=color.white, style=label.style_label_down, size=size.small)
        total_wins := total_wins + 1
        active_direction := 0
        active_entry := na
    else if low <= active_sl
        // LOSS - hit SL
        if show_historical
            label.new(bar_index, active_sl, "LOSS\nSL Hit", color=color.red, textcolor=color.white, style=label.style_label_up, size=size.small)
        total_losses := total_losses + 1
        active_direction := 0
        active_entry := na
    else if trend_reversal_exit_long
        // Trend reversal - check if win or loss
        if close > active_entry
            if show_historical
                label.new(bar_index, close, "WIN\nTrend Rev", color=color.green, textcolor=color.white, style=label.style_label_down, size=size.small)
            total_wins := total_wins + 1
        else
            if show_historical
                label.new(bar_index, close, "LOSS\nTrend Rev", color=color.red, textcolor=color.white, style=label.style_label_up, size=size.small)
            total_losses := total_losses + 1
        active_direction := 0
        active_entry := na

if active_direction == -1  // Short trade active
    if low <= active_tp
        // WIN - hit TP
        if show_historical
            label.new(bar_index, active_tp, "WIN\nTP Hit", color=color.green, textcolor=color.white, style=label.style_label_up, size=size.small)
        total_wins := total_wins + 1
        active_direction := 0
        active_entry := na
    else if high >= active_sl
        // LOSS - hit SL
        if show_historical
            label.new(bar_index, active_sl, "LOSS\nSL Hit", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)
        total_losses := total_losses + 1
        active_direction := 0
        active_entry := na
    else if trend_reversal_exit_short
        // Trend reversal - check if win or loss
        if close < active_entry
            if show_historical
                label.new(bar_index, close, "WIN\nTrend Rev", color=color.green, textcolor=color.white, style=label.style_label_up, size=size.small)
            total_wins := total_wins + 1
        else
            if show_historical
                label.new(bar_index, close, "LOSS\nTrend Rev", color=color.red, textcolor=color.white, style=label.style_label_down, size=size.small)
            total_losses := total_losses + 1
        active_direction := 0
        active_entry := na

// --- New Entry - Create TP/SL Lines and Trade Label ---
if long_signal and active_direction == 0
    active_entry := close
    active_tp := long_tp
    active_sl := long_sl
    active_direction := 1
    active_bar := bar_index

    if show_tp_sl_lines
        line.new(bar_index, long_tp, bar_index + 50, long_tp, color=color.green, width=2, style=line.style_dashed)
        line.new(bar_index, long_sl, bar_index + 50, long_sl, color=color.red, width=2, style=line.style_dashed)
        line.new(bar_index, close, bar_index + 50, close, color=color.blue, width=1, style=line.style_dotted)

    if show_trade_labels
        label.new(bar_index, close,
             "LONG TRADE\n" +
             "Entry: $" + str.tostring(close, "#.##") + "\n" +
             "TP: $" + str.tostring(long_tp, "#.##") + "\n" +
             "SL: $" + str.tostring(long_sl, "#.##") + "\n" +
             "R:R: " + str.tostring(tp_mult/stop_mult, "#.#") + ":1\n" +
             "Vol: " + str.tostring(vol_ratio, "#.#") + "x",
             color=color.new(color.green, 20),
             textcolor=color.white,
             style=label.style_label_up,
             size=size.normal)

if short_signal and active_direction == 0
    active_entry := close
    active_tp := short_tp
    active_sl := short_sl
    active_direction := -1
    active_bar := bar_index

    if show_tp_sl_lines
        line.new(bar_index, short_tp, bar_index + 50, short_tp, color=color.green, width=2, style=line.style_dashed)
        line.new(bar_index, short_sl, bar_index + 50, short_sl, color=color.red, width=2, style=line.style_dashed)
        line.new(bar_index, close, bar_index + 50, close, color=color.blue, width=1, style=line.style_dotted)

    if show_trade_labels
        label.new(bar_index, close,
             "SHORT TRADE\n" +
             "Entry: $" + str.tostring(close, "#.##") + "\n" +
             "TP: $" + str.tostring(short_tp, "#.##") + "\n" +
             "SL: $" + str.tostring(short_sl, "#.##") + "\n" +
             "R:R: " + str.tostring(tp_mult/stop_mult, "#.#") + ":1\n" +
             "Vol: " + str.tostring(vol_ratio, "#.#") + "x",
             color=color.new(color.red, 20),
             textcolor=color.white,
             style=label.style_label_down,
             size=size.normal)

// --- Plot Entry Signals ---
plotshape(long_signal, title="Long Entry", location=location.belowbar, color=color.green, style=shape.triangleup, size=size.small)
plotshape(short_signal, title="Short Entry", location=location.abovebar, color=color.red, style=shape.triangledown, size=size.small)

// --- Trend Background ---
bgcolor(uptrend_4h ? color.new(color.green, 90) : downtrend_4h ? color.new(color.red, 90) : na, title="Trend Background")

// --- Calculate Win Rate ---
total_trades = total_wins + total_losses
win_rate = total_trades > 0 ? (total_wins / total_trades) * 100 : 0

// --- Info Dashboard ---
var table info = table.new(position.top_right, 2, 10, bgcolor=color.new(color.black, 80))
if barstate.islast
    // Trend
    table.cell(info, 0, 0, "4H Trend", text_color=color.white)
    table.cell(info, 1, 0, uptrend_4h ? "UPTREND" : downtrend_4h ? "DOWNTREND" : "NEUTRAL", text_color=uptrend_4h ? color.green : downtrend_4h ? color.red : color.gray)

    // Volume
    table.cell(info, 0, 1, "Volume", text_color=color.white)
    table.cell(info, 1, 1, str.tostring(vol_ratio, "#.#") + "x" + (high_volume ? " OK" : ""), text_color=high_volume ? color.green : color.gray)

    // ATR
    table.cell(info, 0, 2, "ATR(14)", text_color=color.white)
    table.cell(info, 1, 2, str.tostring(atr, "#.##"), text_color=color.white)

    // Stop Distance
    table.cell(info, 0, 3, "Stop Dist", text_color=color.white)
    table.cell(info, 1, 3, str.tostring(atr * stop_mult, "#.##"), text_color=color.red)

    // TP Distance
    table.cell(info, 0, 4, "TP Dist", text_color=color.white)
    table.cell(info, 1, 4, str.tostring(atr * tp_mult, "#.##"), text_color=color.green)

    // R:R Ratio
    table.cell(info, 0, 5, "R:R Ratio", text_color=color.white)
    table.cell(info, 1, 5, str.tostring(tp_mult / stop_mult, "#.#") + ":1", text_color=color.white)

    // Cooldown
    table.cell(info, 0, 6, "Cooldown", text_color=color.white)
    cooldown_remaining = math.max(0, cooldown_bars - bars_since_signal)
    table.cell(info, 1, 6, cooldown_remaining > 0 ? str.tostring(cooldown_remaining) + " bars" : "READY", text_color=cooldown_remaining > 0 ? color.yellow : color.green)

    // Position
    table.cell(info, 0, 7, "Position", text_color=color.white)
    table.cell(info, 1, 7, active_direction == 1 ? "LONG" : active_direction == -1 ? "SHORT" : "FLAT", text_color=active_direction == 1 ? color.green : active_direction == -1 ? color.red : color.gray)

    // Wins
    table.cell(info, 0, 8, "Wins", text_color=color.white)
    table.cell(info, 1, 8, str.tostring(total_wins), text_color=color.green)

    // Losses
    table.cell(info, 0, 9, "Losses", text_color=color.white)
    table.cell(info, 1, 9, str.tostring(total_losses) + " (" + str.tostring(win_rate, "#.#") + "%)", text_color=color.red)

// --- Alerts ---
alertcondition(long_signal, "V14 Long Entry", "V14: Long entry - 15M crossover + 4H uptrend + volume")
alertcondition(short_signal, "V14 Short Entry", "V14: Short entry - 15M crossunder + 4H downtrend + volume")
alertcondition(trend_reversal_exit_long or trend_reversal_exit_short, "Trend Reversal", "V14: 4H trend reversal - consider exit")
